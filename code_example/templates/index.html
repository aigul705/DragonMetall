<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Анализ драгметаллов</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <h1>Рекомендации по торговле драгоценными металлами</h1>
        <div id="dashboard" class="dashboard">
            <div id="loading">Загрузка данных...</div>
        </div>
    </div>

    <script>
        // Функция для получения цветов металлов
        function getMetalColor(metal) {
            const colors = {
                'Au': 'rgba(255, 215, 0, 0.7)',    // золотой
                'Ag': 'rgba(192, 192, 192, 0.7)',  // серебряный
                'Pt': 'rgba(229, 228, 226, 0.7)',  // платина
                'Pd': 'rgba(0, 128, 128, 0.7)'     // палладий
            };
            return colors[metal] || 'rgba(75, 192, 192, 0.7)';
        }

        // Функция для получения русских названий металлов
        function getMetalName(metalCode) {
            const names = {
                'Au': 'Золото',
                'Ag': 'Серебро',
                'Pt': 'Платина',
                'Pd': 'Палладий'
            };
            return names[metalCode] || metalCode;
        }

        // Функция создания карточки металла
        function createMetalCard(metal, data) {
            const card = document.createElement('div');
            card.className = 'metal-card';
            
            // Заголовок с названием и ценой
            const title = document.createElement('h2');
            title.innerHTML = `
                ${getMetalName(metal)} 
                <span class="price">${data.current_price.toFixed(2)} руб</span>
            `;
            card.appendChild(title);

            // Блок рекомендации
            const recommendation = document.createElement('div');
            recommendation.className = `recommendation ${data.general_recommendation.action}`;
            recommendation.innerHTML = `
                <strong>Рекомендация: ${data.general_recommendation.action}</strong><br>
                Уверенность: ${(data.general_recommendation.confidence * 100).toFixed(0)}%<br>
                ${data.general_recommendation.description}
            `;
            card.appendChild(recommendation);

            // График
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            const canvas = document.createElement('canvas');
            chartContainer.appendChild(canvas);
            card.appendChild(chartContainer);

            // Инициализация графика
            setTimeout(() => {
                try {
                    new Chart(canvas, {
                        type: 'line',
                        data: {
                            labels: data.history.dates,
                            datasets: [{
                                label: `${getMetalName(metal)} (руб)`,
                                data: data.history.prices,
                                borderColor: getMetalColor(metal),
                                backgroundColor: getMetalColor(metal),
                                borderWidth: 2,
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.y.toFixed(2)} руб`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: 'Цена (руб)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Дата'
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error(`Ошибка при создании графика для ${metal}:`, error);
                }
            }, 100);

            return card;
        }

        // Основная функция загрузки данных
        async function loadData() {
            try {
                const response = await fetch('/api/recommendations');
                
                if (!response.ok) {
                    throw new Error(`Ошибка HTTP: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status !== 'success' || !result.data) {
                    throw new Error('Неверный формат данных от сервера');
                }
                
                return result.data;
            } catch (error) {
                console.error('Ошибка загрузки данных:', error);
                throw error;
            }
        }

        // Функция отображения ошибки
        function showError(message) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = `
                <div class="error">
                    <h3>Ошибка</h3>
                    <p>${message}</p>
                    <button onclick="location.reload()">Обновить страницу</button>
                </div>
            `;
        }

        // Основная функция инициализации
        async function initDashboard() {
            try {
                const data = await loadData();
                document.getElementById('loading').style.display = 'none';
                
                const dashboard = document.getElementById('dashboard');
                dashboard.innerHTML = '';
                
                // Порядок отображения металлов
                const metalOrder = ['Au', 'Ag', 'Pt', 'Pd'];
                
                metalOrder.forEach(metal => {
                    if (data[metal]) {
                        dashboard.appendChild(createMetalCard(metal, data[metal]));
                    }
                });
                
            } catch (error) {
                showError(error.message);
            }
        }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>